name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Build agent binary
        run: |
          cd packages/agent
          npm run bundle
          cd ../..

      - name: Prepare release package
        run: |
          # Create release directory
          mkdir -p release/vibe-anywhere

          # Copy standalone build
          cp -r .next/standalone/* release/vibe-anywhere/

          # Copy static files to correct location
          mkdir -p release/vibe-anywhere/.next/static
          cp -r .next/static/* release/vibe-anywhere/.next/static/

          # Copy public folder
          if [ -d "public" ]; then
            cp -r public release/vibe-anywhere/
          fi

          # Copy docker files
          cp -r docker release/vibe-anywhere/

          # Copy scripts
          cp -r scripts release/vibe-anywhere/

          # Copy configuration templates
          cp .env.example release/vibe-anywhere/

          # Copy database files for migrations
          cp -r drizzle release/vibe-anywhere/ 2>/dev/null || true
          cp drizzle.config.ts release/vibe-anywhere/ 2>/dev/null || true

          # Copy package.json for scripts
          cp package.json release/vibe-anywhere/

          # Copy agent bundle
          mkdir -p release/vibe-anywhere/packages/agent
          cp packages/agent/agent-bundle.tar.gz release/vibe-anywhere/packages/agent/

          # Create version file
          echo "${{ inputs.version }}" > release/vibe-anywhere/VERSION

          # Create tarball
          cd release
          tar -czvf vibe-anywhere-v${{ inputs.version }}.tar.gz vibe-anywhere

      - name: Detect if pre-release
        id: check_prerelease
        run: |
          VERSION="${{ inputs.version }}"
          if [[ "$VERSION" == *"-"* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "Pre-release detected (contains hyphen)"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "Stable release (no hyphen)"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ inputs.version }}
          name: Vibe Anywhere v${{ inputs.version }}
          body: |
            ## Vibe Anywhere v${{ inputs.version }}

            ${{ steps.check_prerelease.outputs.is_prerelease == 'true' && '**⚠️ This is a pre-release version**' || '' }}

            ### Installation

            ```bash
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/install.sh | sudo bash
            ```

            ### What's Changed

            See the [commit history](https://github.com/${{ github.repository }}/commits/v${{ inputs.version }}) for details.

            ---

            **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ inputs.version }}...v${{ inputs.version }}
          files: |
            release/vibe-anywhere-v${{ inputs.version }}.tar.gz
          draft: false
          prerelease: ${{ steps.check_prerelease.outputs.is_prerelease == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
