# Session Hub - Docker Compose Configuration
# Production-ready stack with PostgreSQL
#
# Usage:
#   Production:  docker compose up -d
#   Development: docker compose up -d (uses override automatically)
#   With debug:  docker compose --profile debug up -d

services:
  # ==========================================================================
  # Session Hub Application
  # ==========================================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: session-hub
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    environment:
      # Database
      DATABASE_URL: postgresql://sessionhub:${POSTGRES_PASSWORD:-sessionhub_dev_password}@postgres:5432/sessionhub

      # Server
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3000

      # Auth
      AUTH_SECRET: ${AUTH_SECRET:?AUTH_SECRET is required}

      # App home directory (where cloned repos, worktrees, SSH keys are stored)
      APP_HOME_DIR: /data

      # Git/Worktree paths (legacy, now derived from APP_HOME_DIR)
      BASE_REPO_PATH: ${BASE_REPO_PATH:-/repos/base}
      WORKTREE_BASE_PATH: /data/.worktrees

      # Container backend
      CONTAINER_BACKEND: ${CONTAINER_BACKEND:-docker}
      DOCKER_SOCKET: /var/run/docker.sock
      CLAUDE_IMAGE: ${CLAUDE_IMAGE:-session-hub/claude-instance:latest}

      # Claude API
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:?ANTHROPIC_API_KEY is required}

      # Session Hub URL (for Proxmox agents to connect back)
      SESSION_HUB_URL: ${SESSION_HUB_URL:-http://localhost:3000}

      # Session settings
      SESSION_IDLE_TIMEOUT_MINUTES: ${SESSION_IDLE_TIMEOUT_MINUTES:-60}
      OUTPUT_BUFFER_SIZE: ${OUTPUT_BUFFER_SIZE:-1000}
    volumes:
      # Docker socket for container management
      - /var/run/docker.sock:/var/run/docker.sock:ro

      # App data directory (cloned repos, worktrees, SSH keys)
      # This persists across container restarts
      - ${HOST_DATA_PATH:-session-hub-data}:/data:rw

      # Git repositories from host (for local/symlinked repos)
      - ${HOST_REPO_PATH:-./repos}:/repos:rw

      # SSH keys for Proxmox (optional)
      - ${HOST_SSH_PATH:-~/.ssh}:/home/sessionhub/.ssh:ro
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3
    networks:
      - session-hub-network

  # ==========================================================================
  # PostgreSQL Database
  # ==========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: session-hub-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: sessionhub
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-sessionhub_dev_password}
      POSTGRES_DB: sessionhub
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sessionhub -d sessionhub"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - session-hub-network

  # ==========================================================================
  # pgAdmin (Debug profile only)
  # ==========================================================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: session-hub-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@sessionhub.local
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    depends_on:
      - postgres
    profiles:
      - debug
    networks:
      - session-hub-network

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  postgres_data:
    name: session-hub-postgres
  session-hub-data:
    name: session-hub-data

# ==========================================================================
# Networks
# ==========================================================================
networks:
  session-hub-network:
    name: session-hub
    driver: bridge
