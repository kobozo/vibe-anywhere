# Vibe Anywhere - Docker Compose Configuration
# Production-ready stack with SQLite (default) or PostgreSQL
#
# Usage:
#   SQLite (default):  docker compose up -d
#   With PostgreSQL:   docker compose -f docker-compose.yml -f docker-compose.postgres.yml up -d
#   Development:       docker compose up -d (uses override automatically)

services:
  # ==========================================================================
  # Vibe Anywhere Application
  # ==========================================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vibe-anywhere
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    environment:
      # Database (empty = SQLite at /data/app.db)
      DATABASE_URL: ${DATABASE_URL:-}

      # Server
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3000

      # Auth
      AUTH_SECRET: ${AUTH_SECRET:?AUTH_SECRET is required}

      # App home directory (where cloned repos, worktrees, SSH keys are stored)
      APP_HOME_DIR: /data

      # Git/Worktree paths (legacy, now derived from APP_HOME_DIR)
      BASE_REPO_PATH: ${BASE_REPO_PATH:-/repos/base}
      WORKTREE_BASE_PATH: /data/.worktrees

      # Vibe Anywhere URL (for Proxmox agents to connect back)
      SESSION_HUB_URL: ${SESSION_HUB_URL:-http://localhost:3000}

      # Session settings
      SESSION_IDLE_TIMEOUT_MINUTES: ${SESSION_IDLE_TIMEOUT_MINUTES:-60}
      OUTPUT_BUFFER_SIZE: ${OUTPUT_BUFFER_SIZE:-1000}
    volumes:
      # App data directory (cloned repos, worktrees, SSH keys)
      # This persists across container restarts
      - ${HOST_DATA_PATH:-vibe-anywhere-data}:/data:rw

      # Git repositories from host (for local/symlinked repos)
      - ${HOST_REPO_PATH:-./repos}:/repos:rw

      # SSH keys for Proxmox (optional)
      - ${HOST_SSH_PATH:-~/.ssh}:/home/vibeanywhere/.ssh:ro
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3
    networks:
      - vibe-anywhere-network

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  vibe-anywhere-data:
    name: vibe-anywhere-data

# ==========================================================================
# Networks
# ==========================================================================
networks:
  vibe-anywhere-network:
    name: vibe-anywhere
    driver: bridge
